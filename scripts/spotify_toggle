#!/usr/bin/env bash

set -e

WORKSPACE="special:spot"

focus() {
	hyprctl 'dispatch togglespecialworkspace spot'
}

active() {
	hyprctl workspaces -j | jq -e '.[] | select(.name == "special:spot")' > /dev/null 2>&1
}

wait_for_windows() {
	local class="$1" count="${2:-1}" timeout=10
	for ((i = 0; i < timeout * 10; i++)); do
		local n
		n=$(hyprctl clients -j | jq "[.[] | select(.workspace.name == \"$WORKSPACE\" and .class == \"$class\")] | length")
		if (( n >= count )); then
			return 0
		fi
		sleep 0.1
	done
	echo "Timed out waiting for $count $class window(s)" >&2
	return 1
}

setup() {
	hyprctl --batch "dispatch exec [workspace $WORKSPACE] flatpak run com.spotify.Client; dispatch layoutmsg preselect l"
	wait_for_windows "Spotify" 1

	hyprctl dispatch exec "[workspace $WORKSPACE] alacritty -o font.size=6 -e cava -p ~/.config/cava/left.conf"
	wait_for_windows "Alacritty" 1
	hyprctl --batch "dispatch resizeactive -60% 0; dispatch movefocus r; dispatch layoutmsg preselect r"

	hyprctl dispatch exec "[workspace $WORKSPACE] alacritty -o font.size=6 -e cava -p ~/.config/cava/right.conf"
	wait_for_windows "Alacritty" 2
	hyprctl dispatch resizeactive 45% 0
}

# if not active run setup
if ! active; then
	setup
	exit 0
fi

# if active then run focus
if active; then
	focus
	exit 0
fi
